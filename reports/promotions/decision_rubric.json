{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "trading-bot/promotion-decision-rubric/v1.0.0",
  "title": "Strategy Promotion Decision Rubric",
  "description": "Schema for recording strategy promotion decisions. All promotions must produce a file conforming to this schema stored in reports/promotions/. See docs/PROMOTION_FRAMEWORK.md for thresholds and process.",
  "type": "object",
  "required": [
    "rubric_version",
    "strategy_id",
    "strategy_name",
    "strategy_version",
    "promotion_level",
    "decision",
    "decision_date",
    "reviewer_ids",
    "metrics",
    "p0_failures",
    "p1_overrides"
  ],
  "additionalProperties": false,
  "properties": {
    "rubric_version": {
      "type": "string",
      "description": "Version of PROMOTION_FRAMEWORK.md used for this decision.",
      "enum": ["1.0.0"],
      "examples": ["1.0.0"]
    },
    "strategy_id": {
      "type": "string",
      "description": "Strategy ID in the format 'name:version' matching StrategyRegistry.",
      "pattern": "^[a-zA-Z0-9_]+:[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["ma_crossover:1.0.0", "rsi_momentum:1.0.0"]
    },
    "strategy_name": {
      "type": "string",
      "description": "Human-readable strategy name.",
      "examples": ["ma_crossover", "rsi_momentum", "bollinger_bands", "macd_crossover"]
    },
    "strategy_version": {
      "type": "string",
      "description": "Semantic version string.",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0"]
    },
    "promotion_level": {
      "type": "string",
      "description": "The promotion transition being evaluated.",
      "enum": [
        "experimental_to_paper",
        "paper_to_live",
        "live_to_production",
        "demotion_to_paper",
        "demotion_to_experimental"
      ]
    },
    "decision": {
      "type": "string",
      "description": "The outcome of the promotion review.",
      "enum": ["APPROVED", "REJECTED", "DEFERRED"]
    },
    "decision_date": {
      "type": "string",
      "description": "ISO 8601 UTC timestamp of the promotion decision.",
      "format": "date-time",
      "examples": ["2026-02-23T10:00:00Z"]
    },
    "review_period_start": {
      "type": "string",
      "description": "Start date of the paper trading period reviewed (ISO 8601 date).",
      "format": "date",
      "examples": ["2026-02-10"]
    },
    "review_period_end": {
      "type": "string",
      "description": "End date of the paper trading period reviewed (ISO 8601 date).",
      "format": "date",
      "examples": ["2026-02-21"]
    },
    "reviewer_ids": {
      "type": "array",
      "description": "List of reviewer identifiers. At least one required; two required for any P1 override.",
      "minItems": 1,
      "maxItems": 5,
      "items": {
        "type": "string",
        "minLength": 1
      },
      "examples": [["alice@example.com"], ["alice@example.com", "bob@example.com"]]
    },
    "environment": {
      "type": "string",
      "description": "Trading environment where paper session was run.",
      "enum": ["alpaca_paper", "ibkr_paper", "ibkr_demo", "alpaca_live", "ibkr_live"],
      "examples": ["alpaca_paper"]
    },
    "market": {
      "type": "string",
      "description": "Primary market for the paper session.",
      "enum": ["US", "UK-LSE", "MULTI"],
      "examples": ["US"]
    },
    "base_currency": {
      "type": "string",
      "description": "Base currency for P&L reporting.",
      "enum": ["USD", "GBP", "EUR"],
      "examples": ["USD"]
    },
    "session_db_path": {
      "type": "string",
      "description": "Path to the SQLite database file used for this paper session.",
      "examples": ["trading_paper.db"]
    },
    "session_summary_path": {
      "type": "string",
      "description": "Path to the paper_session_summary JSON file generated for this review.",
      "examples": ["reports/session/paper_session_summary.json"]
    },
    "metrics": {
      "type": "object",
      "description": "All Gate B metric values captured from paper_session_summary.",
      "required": [
        "closed_trade_count",
        "win_rate",
        "profit_factor",
        "realized_pnl",
        "fill_rate",
        "avg_slippage_pct"
      ],
      "additionalProperties": false,
      "properties": {
        "closed_trade_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of closed (exited) trades in the paper session."
        },
        "win_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Proportion of closed trades that were profitable (0.0 to 1.0)."
        },
        "profit_factor": {
          "type": ["number", "string"],
          "description": "Gross profit / gross loss. Use 'inf' if no losing trades.",
          "examples": [1.35, "inf"]
        },
        "realized_pnl": {
          "type": "number",
          "description": "Net realized P&L in base currency, net of commissions and slippage."
        },
        "fill_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Proportion of submitted orders that received a fill (0.0 to 1.0)."
        },
        "avg_slippage_pct": {
          "type": "number",
          "minimum": 0.0,
          "description": "Average slippage as a percentage of the signal price."
        },
        "avg_fee_per_trade": {
          "type": "number",
          "minimum": 0.0,
          "description": "Average commission/fee per trade in base currency."
        },
        "sharpe_ratio": {
          "type": ["number", "null"],
          "description": "Annualized Sharpe ratio on paper session returns. Null if insufficient data."
        },
        "max_drawdown_pct": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Maximum peak-to-trough drawdown observed during the paper session (0.0 to 1.0)."
        },
        "circuit_breaker_trips": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times any RiskManager circuit breaker was triggered."
        },
        "kill_switch_activations": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of kill switch activations during the paper session."
        },
        "var_breaches": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times portfolio VaR exceeded the configured threshold."
        },
        "unhandled_exceptions": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of CRITICAL severity audit events (unhandled exceptions)."
        },
        "trading_days": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of trading days the paper session covered."
        }
      }
    },
    "p0_failures": {
      "type": "array",
      "description": "List of P0 (blocking) check failures. Must be empty for an APPROVED decision.",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "examples": [
        [],
        ["fill_rate=0.85 < min_fill_rate=0.90", "win_rate=0.42 < min_win_rate=0.50"]
      ]
    },
    "p1_overrides": {
      "type": "array",
      "description": "P1 (urgent) metrics that missed threshold but are being overridden with written justification. Each override requires two reviewers.",
      "items": {
        "type": "object",
        "required": ["metric", "threshold", "actual_value", "justification", "approved_by"],
        "additionalProperties": false,
        "properties": {
          "metric": {
            "type": "string",
            "description": "Name of the metric that missed threshold.",
            "examples": ["sharpe_ratio", "consecutive_loss_halts"]
          },
          "threshold": {
            "type": "number",
            "description": "The configured threshold for this metric."
          },
          "actual_value": {
            "type": "number",
            "description": "The actual value observed during the paper session."
          },
          "justification": {
            "type": "string",
            "minLength": 20,
            "description": "Written explanation for why the override is acceptable."
          },
          "approved_by": {
            "type": "array",
            "minItems": 2,
            "description": "Two reviewer IDs who approved this specific P1 override.",
            "items": {
              "type": "string"
            }
          }
        }
      },
      "examples": [
        [],
        [
          {
            "metric": "sharpe_ratio",
            "threshold": 0.3,
            "actual_value": 0.25,
            "justification": "Session ran during high-volatility FOMC week. The 0.05 miss is within noise. Strategy otherwise performed well on all P0 metrics.",
            "approved_by": ["alice@example.com", "bob@example.com"]
          }
        ]
      ]
    },
    "rejection_reason": {
      "type": "string",
      "description": "Required when decision is REJECTED or DEFERRED. Explains the primary blocking reason.",
      "examples": ["P0 failure: fill_rate=0.85 is below the 0.90 threshold. Execution quality must improve before re-evaluation."]
    },
    "next_review_date": {
      "type": "string",
      "format": "date",
      "description": "For DEFERRED decisions, the planned date of the next review.",
      "examples": ["2026-03-09"]
    },
    "gate_b_automated_output": {
      "type": "array",
      "description": "Raw output from paper_readiness_failures() â€” list of failure strings (empty = all pass).",
      "items": {
        "type": "string"
      },
      "examples": [[], ["win_rate=0.450000 < min_win_rate=0.500000"]]
    },
    "notes": {
      "type": "string",
      "description": "Free-text notes providing additional context for the decision.",
      "examples": ["First promotion attempt for this strategy. All P0 criteria met cleanly after 15 trading days."]
    },
    "rubric_file_sha256": {
      "type": "string",
      "description": "SHA256 hash of this rubric file for immutability verification. Computed after writing.",
      "pattern": "^[a-f0-9]{64}$"
    }
  },
  "if": {
    "properties": {
      "decision": { "const": "APPROVED" }
    }
  },
  "then": {
    "properties": {
      "p0_failures": {
        "maxItems": 0,
        "description": "APPROVED decisions must have zero P0 failures."
      }
    }
  },
  "examples": [
    {
      "rubric_version": "1.0.0",
      "strategy_id": "ma_crossover:1.0.0",
      "strategy_name": "ma_crossover",
      "strategy_version": "1.0.0",
      "promotion_level": "paper_to_live",
      "decision": "APPROVED",
      "decision_date": "2026-02-23T10:00:00Z",
      "review_period_start": "2026-02-09",
      "review_period_end": "2026-02-20",
      "reviewer_ids": ["alice@example.com"],
      "environment": "alpaca_paper",
      "market": "US",
      "base_currency": "USD",
      "session_db_path": "trading_paper.db",
      "session_summary_path": "reports/session/paper_session_summary.json",
      "metrics": {
        "closed_trade_count": 28,
        "win_rate": 0.571,
        "profit_factor": 1.38,
        "realized_pnl": 142.50,
        "fill_rate": 0.96,
        "avg_slippage_pct": 0.0018,
        "avg_fee_per_trade": 0.03,
        "sharpe_ratio": 0.72,
        "max_drawdown_pct": 0.08,
        "circuit_breaker_trips": 0,
        "kill_switch_activations": 0,
        "var_breaches": 0,
        "unhandled_exceptions": 0,
        "trading_days": 10
      },
      "p0_failures": [],
      "p1_overrides": [],
      "gate_b_automated_output": [],
      "notes": "Clean pass on all metrics. Strategy performed consistently across 10 trading days including a moderate-volatility week."
    }
  ]
}
