# Data Models & Schema Reference

Quick reference for all data types, enums, and database schemas used in the trading bot.

---

## Core Data Types (src/data/models.py)

### Enums

```python
class OrderSide(str, Enum):
    BUY = "buy"       # Market buy / Long entry
    SELL = "sell"     # Market sell / Exit long

class OrderStatus(str, Enum):
    PENDING = "pending"      # Submitted, waiting for fill
    FILLED = "filled"        # Completely filled
    CANCELLED = "cancelled"  # Cancelled by user/system
    REJECTED = "rejected"    # Rejected by broker

class SignalType(str, Enum):
    LONG = "long"      # Enter a long position
    SHORT = "short"    # Enter a short position (futures only)
    CLOSE = "close"    # Exit the current position
    HOLD = "hold"      # No action (signal suppressed)
```

---

### Data Models

#### Bar (OHLCV)
Represents a single price bar (candle).

```python
@dataclass
class Bar:
    symbol: str              # e.g., "AAPL", "MSFT"
    timestamp: datetime      # Must be timezone-aware (UTC)
    open: float              # Opening price
    high: float              # Highest price in period
    low: float               # Lowest price in period
    close: float             # Closing price
    volume: float            # Trade volume in shares
    
    # Property
    typical_price: float     # (high + low + close) / 3
```

**Used by:** Backtesting engine, strategies, indicators

**Example:**
```python
bar = Bar(
    symbol="AAPL",
    timestamp=datetime(2024, 1, 15, tzinfo=timezone.utc),
    open=169.50,
    high=172.00,
    low=169.00,
    close=171.50,
    volume=50_000_000.0,
)
```

---

#### Signal
Trading signal generated by a strategy.

```python
@dataclass
class Signal:
    symbol: str              # Which instrument to trade
    signal_type: SignalType  # LONG, SHORT, CLOSE, HOLD
    strength: float          # 0.0 (weak) to 1.0 (strong)
                             # Used for position sizing: qty = strength × max_pos_size
    timestamp: datetime      # When signal was generated
    strategy_name: str       # Which strategy generated this?
    metadata: dict           # Optional: indicator values, reasoning, etc.
```

**Used by:** Strategy → RiskManager → Broker

**Signal flow:**
```
Strategy.generate_signal() → Signal
                                ↓
RiskManager.approve_signal() → Order (or None)
                                ↓
Broker.submit_order()        → Filled (or rejected)
```

**Example:**
```python
signal = Signal(
    symbol="AAPL",
    signal_type=SignalType.LONG,
    strength=0.75,          # 75% conviction = 7.5% of portfolio if max_pos_pct=10%
    timestamp=datetime.now(timezone.utc),
    strategy_name="bollinger_bands",
    metadata={
        "close": 171.50,
        "lower_band": 168.00,
        "middle_band": 172.00,
        "upper_band": 176.00,
    },
)
```

---

#### Order
Order sent to broker for execution.

```python
@dataclass
class Order:
    symbol: str                        # Which instrument
    side: OrderSide                    # BUY or SELL
    qty: float                         # Number of shares
    order_id: str = ""                 # Broker-assigned order ID
    status: OrderStatus = PENDING      # Current order state
    filled_price: Optional[float] = None  # Average fill price (after fill)
    filled_at: Optional[datetime] = None # When order was filled
    stop_loss: Optional[float] = None     # Stop-loss price (limit order)
    take_profit: Optional[float] = None   # Take-profit price (limit order)
```

**Used by:** RiskManager → Broker → Execution

**Lifecycle:**
```
Order(status=PENDING)
    ↓ [submit to broker]
Order(status=FILLED, filled_price=X, filled_at=t)
    ↓ [store in trades]
Position(qty=Q, avg_entry_price=X)
```

**Example:**
```python
order = Order(
    symbol="AAPL",
    side=OrderSide.BUY,
    qty=50.0,
    stop_loss=165.00,       # 2× ATR → automatic stop
    take_profit=180.00,     # Profit target
)
```

---

#### Position
Current open position in portfolio.

```python
@dataclass
class Position:
    symbol: str                # Which instrument
    qty: float                 # Number of shares owned
    avg_entry_price: float     # Average price paid per share
    current_price: float       # Current market price
    
    # Properties
    market_value: float        # qty × current_price
    unrealized_pnl: float      # qty × (current_price - avg_entry_price)
    unrealized_pnl_pct: float  # (current_price - avg_entry_price) / avg_entry_price
```

**Used by:** Portfolio tracker, risk manager

**Example:**
```python
position = Position(
    symbol="AAPL",
    qty=50.0,
    avg_entry_price=170.00,
    current_price=175.00,
)
# market_value = 50 × 175 = $8,750
# unrealized_pnl = 50 × (175 - 170) = $250
# unrealized_pnl_pct = 5 / 170 = 2.94%
```

---

## Configuration Dataclasses (config/settings.py)

#### DataConfig
Market data source, symbols, timeframe.

```python
@dataclass
class DataConfig:
    source: str = "yfinance"          # yfinance | polygon | alpha_vantage | alpaca
    symbols: List[str] = [             # Which instruments to trade
        "AAPL", "MSFT", "GOOGL", "AMZN", "TSLA"
    ]
    timeframe: str = "1d"              # 1m | 5m | 15m | 1h | 1d
    lookback_days: int = 365           # How much history to fetch for features
```

---

#### StrategyConfig
Strategy name and hyperparameters.

```python
@dataclass
class StrategyConfig:
    name: str = "ma_crossover"         # Strategy to run
    
    # Moving Average Crossover
    fast_period: int = 20              # Fast MA (days)
    slow_period: int = 50              # Slow MA (days)
    
    # RSI Momentum
    rsi_period: int = 14               # RSI lookback
    rsi_oversold: float = 30.0         # Oversold threshold
    rsi_overbought: float = 70.0       # Overbought threshold
    
    # Bollinger Bands
    bb_period: int = 20                # SMA period
    bb_std: float = 2.0                # Standard deviations
```

**Override at runtime:**
```python
settings = Settings()
settings.strategy.name = "rsi_momentum"
settings.strategy.rsi_period = 21  # Custom period
```

---

#### RiskConfig
Risk management parameters.

```python
@dataclass
class RiskConfig:
    # Position sizing
    max_position_pct: float = 0.10        # Max 10% in one position
    max_portfolio_risk_pct: float = 0.02  # Risk max 2% per trade
    stop_loss_pct: float = 0.05           # 5% hard stop
    take_profit_pct: float = 0.15         # 15% target
    
    # Portfolio limits
    max_open_positions: int = 10          # Max 10 concurrent positions
    max_drawdown_pct: float = 0.20        # Halt at 20% DD (circuit breaker)
```

---

#### BrokerConfig
Broker connection parameters.

```python
@dataclass
class BrokerConfig:
    provider: str = "alpaca"                              # Which broker
    api_key: str = os.getenv("ALPACA_API_KEY", "")       # From .env
    secret_key: str = os.getenv("ALPACA_SECRET_KEY", "") # From .env
    paper_trading: bool = True                            # Use paper account
    base_url: str = "https://paper-api.alpaca.markets"   # Endpoint
```

---

#### Settings
Root configuration object (composite of above).

```python
@dataclass
class Settings:
    data: DataConfig = field(default_factory=DataConfig)
    strategy: StrategyConfig = field(default_factory=StrategyConfig)
    risk: RiskConfig = field(default_factory=RiskConfig)
    broker: BrokerConfig = field(default_factory=BrokerConfig)
    initial_capital: float = 100_000.0
    log_dir: Path = Path("logs")
```

---

## Database Schema (Planned for Pillar 1)

### Instruments Table
Track all tradable instruments.

```sql
CREATE TABLE instruments (
    id             INTEGER PRIMARY KEY,
    symbol         TEXT UNIQUE NOT NULL,           -- "AAPL"
    exchange       TEXT,                           -- "NYSE"
    asset_class    TEXT,                           -- "equity"
    currency       TEXT DEFAULT 'USD',
    tick_size      REAL,                           -- Min price movement
    source         TEXT DEFAULT 'yfinance',
    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### Bars Table (Time-Series)
OHLCV data, optimized for range queries.

```sql
CREATE TABLE bars (
    id             INTEGER PRIMARY KEY,
    instrument_id  INTEGER NOT NULL,
    timestamp      TIMESTAMP NOT NULL,
    timeframe      TEXT DEFAULT '1d',              -- "1m", "5m", "1h", "1d"
    open           REAL NOT NULL,
    high           REAL NOT NULL,
    low            REAL NOT NULL,
    close          REAL NOT NULL,
    volume         REAL NOT NULL,
    source         TEXT DEFAULT 'yfinance',
    environment    TEXT DEFAULT 'dev',             -- dev | sandbox | prod
    created_at     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (instrument_id) REFERENCES instruments(id),
    UNIQUE (instrument_id, timestamp, timeframe),
    INDEX (instrument_id, timestamp DESC)         -- Fast lookups
);
```

---

### Trades Table
All executed trades (for audit trail).

```sql
CREATE TABLE trades (
    id                  INTEGER PRIMARY KEY,
    strategy_id         TEXT NOT NULL,             -- "ma_crossover", "rsi_momentum"
    strategy_version    TEXT,                      -- "0.1.0"
    instrument_id       INTEGER NOT NULL,
    timestamp           TIMESTAMP NOT NULL,
    side                TEXT NOT NULL,             -- "buy", "sell"
    qty                 REAL NOT NULL,
    entry_price         REAL NOT NULL,
    exit_price          REAL,                      -- NULL if not yet closed
    exit_timestamp      TIMESTAMP,
    pnl                 REAL,                      -- Exit - Entry (for closed trades)
    pnl_pct             REAL,
    stop_loss           REAL,
    take_profit         REAL,
    stop_loss_triggered BOOLEAN DEFAULT FALSE,
    take_profit_triggered BOOLEAN DEFAULT FALSE,
    environment         TEXT DEFAULT 'dev',
    created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (instrument_id) REFERENCES instruments(id),
    INDEX (strategy_id, timestamp DESC),
    INDEX (environment, timestamp DESC)
);
```

---

### Corporate Actions Table
Stock splits, dividends.

```sql
CREATE TABLE corporate_actions (
    id              INTEGER PRIMARY KEY,
    instrument_id   INTEGER NOT NULL,
    effective_date  DATE NOT NULL,
    type            TEXT NOT NULL,                 -- "split", "dividend"
    factor          REAL,                          -- For splits: 2.0 = 2:1 split
    amount          REAL,                          -- For dividends: $X per share
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (instrument_id) REFERENCES instruments(id),
    UNIQUE (instrument_id, effective_date, type)
);
```

---

## Data Flow Diagram

```
Historical Data (CSV/API)
        ↓
   Data Ingestion
        ↓
   Validation (OHLC, volume checks)
        ↓
   Store → SQLite (bars, instruments, trades)
        ↓
   Backtesting Engine / Live Trading
        ↓
   Strategy (generates Signals)
        ↓
   RiskManager (approves → Order)
        ↓
   Broker (executes → filled trade)
        ↓
   Portfolio (tracks positions, P&L)
        ↓
   Report (daily P&L, Sharpe, etc.)
```

---

## Type Hints & Conventions

**Always use type hints:**
```python
def generate_signal(self, symbol: str) -> Optional[Signal]:
    """Docstring explaining return value."""
    ...

def compute_moving_average(prices: pd.Series, period: int) -> pd.Series:
    """Return SMA as pandas Series."""
    ...

def on_bar(self, bar: Bar) -> Optional[Signal]:
    """Process incoming bar, return Signal or None."""
    ...
```

**Timezone conventions:**
- All timestamps must be **timezone-aware** (use `datetime(..., tzinfo=timezone.utc)`)
- Convert to UTC if using external data (Alpaca gives US/Eastern, convert to UTC)
- Store & compare in UTC only

**Numeric precision:**
- Prices: 4 decimal places (e.g., `169.5000`)
- Quantities: floats (fractional shares allowed)
- Returns/percentages: 4-6 decimal places (e.g., `0.0234` = 2.34%)

**Naming conventions:**
- Strategy class names: `*Strategy` (e.g., `BollingerBandsStrategy`)
- Signal types: `SignalType.LONG`, `SignalType.CLOSE` (constants, not strings)
- DataFrame columns: lowercase with underscores (e.g., `volume`, `typical_price`)

---

## Quick Reference: Signal Strength to Position Size

Signal strength is 0.0 (weak) to 1.0 (strong). Maps to position sizing:

```python
position_size = signal.strength × max_position_pct × portfolio_value / price

# Example:
strength = 0.75
max_position_pct = 0.10        # 10% max per position
portfolio_value = $100_000
price = $170.00

position_size = 0.75 × 0.10 × $100_000 / $170.00
              = $750 / $170
              ≈ 4.4 shares (rounded)
```

---

## Error Handling Conventions

**Data errors (raise exceptions):**
```python
if close_price < 0:
    raise ValueError(f"Invalid close price: {close_price}")

if len(df) < min_bars_required:
    raise ValueError(f"Insufficient bars: {len(df)} < {min_bars_required}")
```

**Trading errors (return None, log warning):**
```python
def generate_signal(self, symbol: str) -> Optional[Signal]:
    if len(self._bar_history.get(symbol, [])) < self.min_bars_required():
        # Not enough data yet — normal condition
        return None
    
    if np.isnan(moving_avg):
        # Data quality issue — wait for next bar
        logging.warning(f"NaN in indicator for {symbol}")
        return None
```

