// Global screen width
var screenWidth;

// Variables to condense nav on scroll up/down
var scrollThresholdToMinimizeNav = 50;
var scrollingDown = true;
var scrollPosition;
var startingScrollPosition;
var scrollThresholdStartPosition;

jQuery(document).ready(function() {
	screenWidth = jQuery(window).width();
	
	// Megamenu trigger
	jQuery('.main-nav ul li').hover(function() {
		jQuery('.megamenu').removeClass('active').removeClass('animate-in');
		
		var targetMegamenu = '.megamenu.' + jQuery(this).data('megamenu');
		jQuery(targetMegamenu).addClass('active');
		setTimeout(function() {
//			console.log('actived');
			jQuery(targetMegamenu).addClass('animate-in');
		}, 5);
		
		// Dynamic background height
		jQuery('.megamenu.megamenu-dynamic-background').addClass('active');
		jQuery('.megamenu.megamenu-dynamic-background').height(jQuery(targetMegamenu).height());
		// console.log('.megamenu.' + jQuery(this).data('megamenu'));
	});
	
	jQuery('.main-nav ul li').mouseout(function() {
		if (jQuery('.megamenu:hover').length == 0) {
			jQuery('.megamenu').removeClass('active').removeClass('animate-in');
		
			jQuery('.megamenu.megamenu-dynamic-background').height(0);
		}
	});
	
	jQuery('.megamenu').mouseleave(function() {
		jQuery('.megamenu').removeClass('active').removeClass('animate-in');
		
		jQuery('.megamenu.megamenu-dynamic-background').height(0);
	});
	
	// Mobile navigation
	jQuery('.mobile-nav-open').click(function() {
		jQuery('.mobile-nav').addClass('active');
		jQuery('html, body').addClass('scroll-lock');
	});
	
	jQuery('.mobile-nav-close').click(function() {
		jQuery('.mobile-nav').removeClass('active');
		jQuery('html, body').removeClass('scroll-lock');
	});
	
	jQuery('.mobile-nav-fade').mousedown(function() {
		jQuery('.mobile-nav').removeClass('active');
		jQuery('html, body').removeClass('scroll-lock');
	});
	
	// Desktop search functionality
	jQuery('#search_header svg').click(function(event) {
		if (!jQuery('#search_header form').hasClass('active')) {
			event.preventDefault();
			jQuery('#search_header form').addClass('active');
			jQuery('#search_header form > input').focus();
		}
	});
	
	jQuery('html, body, header').mousedown(function(event) {
		if (!jQuery(event.target).is('#search_header') && !jQuery(event.target).is('#search_header form > input') && !jQuery(event.target).is('#search_header form svg')) {
			jQuery('#search_header form').removeClass('active');
		}
	});
	
	// Dark Mode CSS Transition Manager
	const transitionManager = () => {
		// Create HTML style element with CSS selector that targets all
		// elements and applies CSS to disable transitions
		const style = document.createElement("style");
		const css = document.createTextNode(`* {
			-webkit-transition: none !important;
			-moz-transition: none !important;
			-o-transition: none !important;
			-ms-transition: none !important;
			transition: none !important;
		}`);
		style.appendChild(css);

		// Create functions for adding and remove the style element from
		// the page <head> tag
		const enable = () => document.head.removeChild(style);
		const disable = () => document.head.appendChild(style);
		return {enable, disable, style};
	};
	// Dark Mode Set
	if (getCookie('data-theme')) {
		jQuery('html').attr('data-theme', getCookie('data-theme'));
		// Set PHP dark mode preference
		jQuery.ajax({
			type: "POST",
			url: "/campus/wp-content/themes/campus-theme/js/ajax-js-dark-mode-toggle.php?3",
			data: {"data-theme": getCookie('data-theme')}
		});
	}
	// Dark Mode Toggle
	jQuery('.dark-mode-toggle').click(function() {
		var $dataTheme;
		if (jQuery('html').attr('data-theme') == 'light') {
			$dataTheme = 'dark';
		} else {
			$dataTheme = 'light';
		}
		
		const transitions = transitionManager();
		// Disable CSS transitions
		transitions.disable();
		// Toggle dark mode
		jQuery('html').attr('data-theme', $dataTheme);
		// Enable CSS transitions after the browsers UI refreshes
		window.requestAnimationFrame(transitions.enable);
		
		// Set dark mode preference for 90 days
		optionsSet('data-theme', $dataTheme, 90);
		// Set PHP dark mode preference
		jQuery.ajax({
			type: "POST",
			url: "/campus/wp-content/themes/campus-theme/js/ajax-js-dark-mode-toggle.php?3",
			data: {"data-theme": $dataTheme}
		});
	});
	
	// Set initial scroll values on page load
	scrollPosition = jQuery(window).scrollTop();
	startingScrollPosition = jQuery(window).scrollTop();
	scrollThresholdStartPosition = jQuery(window).scrollTop();
	
	// YouTube Course Popout
	UpdateYouTubeCoursePopout();
	
	// Pillar Carousel functions
	if (jQuery('#pillar-carousel').length) {
		
		if (screenWidth < 992) {
			jQuery('#pillar-carousel').carousel({
				interval: false,
				ride: false
			});
		}
		
		var pillarCarousel = jQuery('#pillar-carousel');

		pillarCarousel.on('slide.bs.carousel', function (event) {
//			console.log(event);
			jQuery('.pillar-nav').removeClass('active');
			jQuery('.pillar-nav[data-bs-slide-to="' + event.to + '"]').addClass('active');
//			console.log(event.to);
//			console.log('.pillar-nav[data-bs-slide-to="' + event.to + '"]');
		});
	}
	
	if (jQuery('#glossary-shuffle-term').length) {
		glossaryShuffle();
	}
	
	UpdateFredCharts();
	
	
	// shorts Carousel functions
		jQuery('#carousel_shorts').carousel({
				interval: false,
				ride: false // Don't start carousel automatically
		});
	
	// don't auto play hidden videos
    jQuery('#carousel_shorts').on('slide.bs.carousel', function () {
        jQuery('#carousel_shorts iframe').each(function () {
            this.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        });
    });
	// auto play active video
    jQuery('#carousel_shorts').on('slid.bs.carousel', function (event) {
        // Autoplay the active video
        var activeSlide = jQuery(event.relatedTarget).find('iframe');
        if (activeSlide.length > 0) {
            activeSlide[0].contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        }
    });
		// END shorts Carousel functions
	
});

jQuery(window).scroll(function() {
	scrollPosition = jQuery(window).scrollTop();
	
	// Pillar Carousel functions
	if (jQuery('#pillar-carousel').length) {
		if (screenWidth < 992) {
			jQuery('#pillar-carousel').carousel({
				interval: false,
				ride: false
			});
		} else {
			var carouselInterval = jQuery('#pillar-carousel').data('bs-interval');
			jQuery('#pillar-carousel').carousel({
				interval: carouselInterval,
				ride: 'carousel'
			});
		}
	}
	
	// YouTube Course Popout
	UpdateYouTubeCoursePopout();
	
	// Header functions
	// Check if the user is scrolling up or down
	if (scrollPosition < startingScrollPosition) {
		if (scrollingDown) {
			scrollThresholdStartPosition = scrollPosition;
		}
		
		scrollingDown = false;
	} else {
		if (!scrollingDown) {
			scrollThresholdStartPosition = scrollPosition;
		}
		
		scrollingDown = true;
	}
	
	startingScrollPosition = scrollPosition;
	
	// If the user is past the scroll threshold in the direction they're scrolling add or remove the 'condensed' class to the header
	if (scrollingDown) {
		if (Math.abs(scrollPosition - scrollThresholdStartPosition) > scrollThresholdToMinimizeNav) {
			jQuery('header.global').addClass('condensed');
			
			if (jQuery('header.pillar').length) {
				jQuery('header.pillar').addClass('condensed');
			}
		}
	} else {
		if (Math.abs(scrollPosition - scrollThresholdStartPosition) > scrollThresholdToMinimizeNav) {
			
			// Redoc exception - revise
			if (!jQuery('body').hasClass('postid-195580')) {
			
				if (jQuery('header.pillar').length) {
					jQuery('header.pillar').removeClass('condensed');
				} else {
					jQuery('header.global').removeClass('condensed');
				}
				
			} else {
				
				if (scrollPosition < 215) {
					if (jQuery('header.pillar').length) {
						jQuery('header.pillar').removeClass('condensed');
					} else {
						jQuery('header.global').removeClass('condensed');
					}
				}
				
			}
		}
	}
	
	// Debug values
//	console.log('------------');
//	console.log('scrolling down: ' + scrollingDown);
//	console.log('starting scroll position: ' + startingScrollPosition);
//	console.log('scroll position: ' + scrollPosition);
//	console.log('scroll threshold start position: ' + scrollThresholdStartPosition);
//	console.log('difference: ' + Math.abs(scrollPosition - startingScrollPosition));
});

jQuery(window).resize(function() {
	screenWidth = jQuery(window).width();
	
	// Remove scroll lock when resizing to desktop if mobile menu is open
	if (screenWidth >= 992) {
		if (!jQuery('header.global').hasClass('api-condensed')) {
			jQuery('.mobile-nav').removeClass('active');
			jQuery('html, body').removeClass('scroll-lock');
		}
	} else {
		jQuery('.megamenu').removeClass('active');

	}
	
	// Clear megamenus if resizing to mobile menu screen width
	if (jQuery('.megamenu.active').length > 0) {
		jQuery('.megamenu.megamenu-dynamic-background').height(jQuery('.megamenu.active:not(.megamenu-dynamic-background)').height());
	}
	
	// YouTube Course Popout
	UpdateYouTubeCoursePopout();
	
	UpdateFredCharts();
});

// Fred Charts
var updateFredChartsTimeout;
function UpdateFredCharts() {
	if (jQuery('.fred-iframe').length) {
		clearTimeout(updateFredChartsTimeout);
		updateFredChartsTimeout = setTimeout(function() {
			jQuery('.fred-iframe iframe').each(function() {
				var parentDivWidth = jQuery(this).parent('div').innerWidth();
				var src = jQuery(this).attr('src');
				src = new URL(src);
				src.searchParams.set('width', parentDivWidth);
				jQuery(this).attr('src', src);
				jQuery(this).width(parentDivWidth);
				//jQuery(this).location.reload();
			});
		}, 150);
	}
}

// TA YouTube popout on scroll
var openYouTube = true;
var youTubeVideoTop;
var youTubeMobileBreakpoint = 768;
function UpdateYouTubeCoursePopout() {
	// Exit if the YouTube popout doesn't exist
	if (!jQuery('.youtube-course-popout').length) {
		return false;
	}
	
	// Set vertical breakpoint for popping out video
	if (screenWidth < youTubeMobileBreakpoint) {
		youTubeVideoTop = parseInt(jQuery('.youtube-course-popout').parent().offset().top - 100);
	} else {
		youTubeVideoTop = parseInt(jQuery('.youtube-course-popout').parent().offset().top + jQuery('.youtube-course-popout').parent().height() - 100 );
	}
	
	jQuery('#youtube-course-popout-close').click(function() {
		openYouTube = false;
		jQuery('.youtube-course-popout').removeClass('active');
	});

	if (scrollPosition > youTubeVideoTop) {
		if (!jQuery('.youtube-course-popout').hasClass('active')) {
			if (openYouTube) {
				jQuery('.youtube-course-popout').addClass('active');
				if (screenWidth >= youTubeMobileBreakpoint) {
					jQuery('.youtube-course-popout').hide();
					jQuery('.youtube-course-popout').fadeIn(300);
				}
			}
		}
	} else {
		openYouTube = true;
		if (jQuery('.youtube-course-popout').hasClass('active')) {
			jQuery('.youtube-course-popout').removeClass('active');
			if (screenWidth >= youTubeMobileBreakpoint) {
				jQuery('.youtube-course-popout').hide();
				jQuery('.youtube-course-popout').fadeIn(300);
			}
		}
	}
}

// Glossary AJAX functions
function glossaryLiveSearch(str, liveSearchID) {
	if (str.length == 0) {
		document.getElementById(liveSearchID).innerHTML = "";
		//document.getElementById("livesearch").style.border = "0px";
		return;
	}
	var xmlhttp = new XMLHttpRequest();
	if (str.length > 1) {
		document.getElementById(liveSearchID).innerHTML = "<p>Loading...</p>";
	}
	xmlhttp.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			document.getElementById(liveSearchID).innerHTML = this.responseText;
			//document.getElementById("livesearch").style.border = "1px solid #A5ACB2";
		}
	}
	xmlhttp.open("GET", "/campus/wp-content/themes/campus-theme/inc/common/glossary-search.php?q=" + str, true);
	xmlhttp.send();
}

// Stock Ticker Search AJAX functions
function stockLiveSearch(str, liveSearchID) {
	if (str.length == 0) {
		document.getElementById(liveSearchID).innerHTML = "";
		//document.getElementById("livesearch").style.border = "0px";
		return;
	}
	var xmlhttp = new XMLHttpRequest();
	if (str.length > 1) {
		document.getElementById(liveSearchID).innerHTML = "<p>Loading stocks...</p>";
	}
	xmlhttp.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			document.getElementById(liveSearchID).innerHTML = this.responseText;
			//document.getElementById("livesearch").style.border = "1px solid #A5ACB2";
		}
	}
	xmlhttp.open("GET", "/campus/wp-content/themes/campus-theme/inc/common/stock-search.php?q=" + str, true);
	xmlhttp.send();
}

function relaxedSearch(searchString, targetString) {
	const searchStringSanitized = searchString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	
    // Create a regular expression to allow flexible whitespace, including non-breaking spaces
    const relaxedPattern = new RegExp(searchStringSanitized.replace(/\s+/g, '\\s*'), 'i');
    
    // Test if the target string matches the pattern
    return relaxedPattern.test(targetString);
}

// API Live Search function
function apiLiveSearch(str, liveSearchID) {
    if (str.length == 0) {
        document.getElementById('api-search-results').innerHTML = "";
        document.getElementById('full-search-results').innerHTML = "";
        return;
    }

    var results = '';
    var fullResults = '';
    
    if (str.length > 2) {
        document.getElementById('api-search-results').innerHTML = "<p>Loading results...</p>";
        
        // Convert the search string to lowercase for case-insensitive matching
        str = str.toLowerCase();

        // Loop through the searchIndex array (passed from the PHP file via wp_localize_script)
        searchData.searchIndex.forEach(function(item) {
            var itemHeading = item.Heading.toLowerCase();
            var itemContent = item.Content.toLowerCase();
            var matchFound = itemHeading.includes(str) || itemContent.includes(str);

            if (matchFound) {
                // Generate the basic search result link
                results += '<a href="' + item.Anchor + '">' + item.Heading + '</a>';

                // Generate the full search result with highlighted summary
                var summary = generateSummaryWithHighlight(item.Content, str);
                fullResults += `
                    <a href="${item.Anchor}"><h3>${item.Heading}</h3></a>
                    <p>${summary}</p>
                `;
            }
        });

        // If no results are found, display a message
        if (results === '') {
            results = '<p>No results found.</p>';
        }

        document.getElementById('api-search-results').innerHTML = results;
        document.getElementById('full-search-results').innerHTML = fullResults;

        // Scroll to the element on link click in 'api-search-results'
        jQuery('#api-search-results a').click(function(e) {
            e.preventDefault();
            jQuery('html, body').scrollTop(jQuery(jQuery(this).attr('href')).offset().top - 130);
        });
		
		jQuery('#full-search-results a').click(function() {
			jQuery('#full-search-results-modal').removeClass('show');
		});
    }
}

// Function to generate a summary with the matched term highlighted
function generateSummaryWithHighlight(content, searchTerm) {
    var matchIndex = content.toLowerCase().indexOf(searchTerm);
    if (matchIndex !== -1) {
        // Set the start and end points for a snippet around the matched term
        var start = Math.max(0, matchIndex - 100);
        var end = Math.min(content.length, matchIndex + searchTerm.length + 100);
        
        // Get the snippet and highlight the matched term
        var snippet = content.substring(start, end);
        var highlightedSnippet = snippet.replace(new RegExp(searchTerm, 'gi'), function(match) {
            return '<strong>' + match + '</strong>';
        });
        
        return highlightedSnippet.length > 260 ? highlightedSnippet.substring(0, 260) + '...' : highlightedSnippet;
    } else {
        // If no match, return the first 260 characters as the summary
        return content.substring(0, 260) + (content.length > 260 ? '...' : '');
    }
}


function glossaryShuffle() {
	var xmlhttp = new XMLHttpRequest();
	// Swap out previous term with loading wheel
	document.getElementById('glossary-shuffle-term').innerHTML = '<div class="loading white"><svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M35.1487 20.116C35.1487 11.8616 28.4575 5.16962 20.2023 5.16962C11.9479 5.16962 5.25586 11.8616 5.25586 20.116H8.51026C8.51026 13.6592 13.7447 8.42402 20.2023 8.42402C26.6599 8.42402 31.8943 13.6584 31.8943 20.116H35.1487Z" fill="#000"/></svg></div>';
	document.getElementById('glossary-shuffle').style.display = 'none';
	xmlhttp.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			// Populate new term
			document.getElementById('glossary-shuffle-term').innerHTML = this.responseText;
			document.getElementById('glossary-shuffle').style.display = 'flex';
		}
	}
	xmlhttp.open("POST", "/campus/wp-content/themes/campus-theme/inc/common/glossary-shuffle.php", true);
	xmlhttp.send();
}

// search box in header script
/*
var searchBox = document.getElementById("search_header");
var openSearch = document.getElementById("search_default");
document.onclick = function(e){
	if(e.target === openSearch){
	setTimeout(function () {
	searchBox.classList.add("search-header-on");
	searchBox.classList.remove("search-header-off");
	openSearch.classList.remove("search-default-on");
	openSearch.classList.add("search-default-off");
	document.getElementById("s").focus();
	}, 0);
	}
	if (!searchBox.contains(e.target)){
	searchBox.classList.remove("search-header-on");
	searchBox.classList.add("search-header-off");
	openSearch.classList.remove("search-default-off");
	openSearch.classList.add("search-default-on");
	}
};
*/

// get site JSON url
var WpJsonUrl = document.querySelector('link[rel="https://api.w.org/"]').href;
// take out the '/wp-json/' and 'https:' part
var WpRemoveURL = WpJsonUrl.replace('/wp-json/','');
var thisSiteURL = WpRemoveURL.replace('https://','');




jQuery('.manage-cookies').click(function() {
	jQuery('#privacy-bar').removeClass('bar-off').addClass('bar-on');
	
	jQuery('#your_privacy').removeClass('show').removeClass('active');
	jQuery('#functional').addClass('show').addClass('active');
});



jQuery('#cookieForm button[value="Submit"]').click(function() {
	if (jQuery('#functional input[value="yes"]').is(':checked')) {
  		functionalOptIn();
	}
});



jQuery('#modal-privacy button').click(function() {
	jQuery('#modal-privacy').modal('hide');
		
	if (/(^|;)\s*IBKRcampus_functional_optIn/.test(document.cookie) || jQuery('#functional input[value="yes"]').is(':checked')) {
		populateYTVideoCookiePlaceholder();
	}
});


// cookie manage pop up settings
document.getElementById('cookieForm').addEventListener('submit', function (e) {
e.preventDefault();

//////set up performance cookie
var performanceRadio = document.querySelectorAll('input[name="performance"]');
var performanceValue = null;
for (var i = 0; i < performanceRadio.length; i++) {
	if (performanceRadio[i].checked) {
	performanceValue = performanceRadio[i].value;
	break;
	}
}
if (performanceValue === 'yes') {
	gdprOptIn();
} else if (performanceValue === 'no') {
	gdprOptOut();
} else {
	// do nothing
}

// set up functional cookie
var functionalRadio = document.querySelectorAll('input[name="functional"]');
var functionalValue = null;
for (var i = 0; i < functionalRadio.length; i++) {
	if (functionalRadio[i].checked) {
	functionalValue = functionalRadio[i].value;
	break;
	}
}
if (functionalValue === 'yes') {
	// can't opt into options cookie until user sees the ODD popup.
	// optionsOptIn();
} else if (functionalValue === 'no') {
	optionsOptOut();
} else {
	// do nothing
}

//set up marketing cookie
var marketingRadio = document.querySelectorAll('input[name="marketing"]');
var marketingValue = null;
for (var i = 0; i < marketingRadio.length; i++) {
	if (marketingRadio[i].checked) {
	marketingValue = marketingRadio[i].value;
	break;
	}
}
if (marketingValue === 'yes') {
	mktngOptIn();
} else if (marketingValue === 'no') {
	mktngOptOut();
} else {
	// do nothing
}
});
// END cookie manager pop up settings

function writeGoogleTags() {
    // Define tags for US and EU
    const tags = {
        us: {
            gtagConfig: 'G-3DZW8R5ZLR',
            gtmID: 'GTM-M3LR247',
            head: `
                <!-- Google tag (gtag.js) -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=G-3DZW8R5ZLR"></script>
                <script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', 'G-3DZW8R5ZLR');
                </script>
                
                <!-- Google Tag Manager -->
                <script>
                    (function(w,d,s,l,i){
                        w[l]=w[l]||[];
                        w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
                        var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        'https://www.googletagmanager.com/gtm.js?id='+i+dl;
                        f.parentNode.insertBefore(j,f);
                    })(window,document,'script','dataLayer','GTM-M3LR247');
                </script>
            `,
            body: `
                <!-- Google Tag Manager (noscript) -->
                <noscript>
                    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M3LR247" 
                            height="0" width="0" style="display:none;visibility:hidden"></iframe>
                </noscript>
            `
        },
        eu: {
            gtagConfig: 'G-L1ZLWFHZRS',
            gtmID: 'GTM-MDLB2Q7H',
            head: `
                <!-- Google tag (gtag.js) -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=G-L1ZLWFHZRS"></script>
                <script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', 'G-L1ZLWFHZRS');
                </script>
                
                <!-- Google Tag Manager -->
                <script>
                    (function(w,d,s,l,i){
                        w[l]=w[l]||[];
                        w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
                        var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        'https://www.googletagmanager.com/gtm.js?id='+i+dl;
                        f.parentNode.insertBefore(j,f);
                    })(window,document,'script','dataLayer','GTM-MDLB2Q7H');
                </script>
            `,
            body: `
                <!-- Google Tag Manager (noscript) -->
                <noscript>
                    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MDLB2Q7H" 
                            height="0" width="0" style="display:none;visibility:hidden"></iframe>
                </noscript>
            `
        }
    };

    // Check domain
    const isUS = window.location.href.indexOf('.com') >= 0;
    const selectedTags = isUS ? tags.us : tags.eu;

    // Write tags to the <head>
    if (selectedTags.head) {
        document.head.insertAdjacentHTML('beforeend', selectedTags.head.trim());
    }

    // Write tags after <body>
    if (selectedTags.body) {
        document.body.insertAdjacentHTML('afterbegin', selectedTags.body.trim());
    }
	
    // GA4 Reinitialization
    window.dataLayer = window.dataLayer || [];
    function gtag() { window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', selectedTags.gtagConfig);

    // GTM Reinitialization
    const gtmScript = document.createElement('script');
    gtmScript.async = true;
    gtmScript.src = `https://www.googletagmanager.com/gtm.js?id=${selectedTags.gtmID}`;
    document.head.appendChild(gtmScript);
}

/**
 * Trigger IBKR cookie fetch by calling corporate endpoint directly
 */
function setIBKRCookieAjax() {
    console.log('setIBKRCookie() called');
    
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://www.interactivebrokers.com/response_handler/campus/getCookie.php', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.withCredentials = true;
    
    xhr.onload = function() {
        console.log('AJAX response received:', xhr.status);
        
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                console.log('Response:', response);
                
                if (response.cookie_id) {
                    const currentLocalStorage = localStorage.getItem('web');
                    if (currentLocalStorage !== response.cookie_id) {
                        localStorage.setItem('web', response.cookie_id);
                        console.log('localStorage updated to:', response.cookie_id);
                    }
                    console.log('IBKR Cookie set successfully');
                } else {
                    console.error('No cookie_id in response:', response);
                }
            } catch (e) {
                console.error('Error parsing response:', e);
            }
        } else {
            console.error('AJAX request failed with status:', xhr.status);
        }
    };
    
    xhr.onerror = function() {
        console.error('Network error in setIBKRCookie');
    };
    
    const data = JSON.stringify({
        setCookie: 'T',
        referrer: '',
        requestURI: '',
        src: ''
    });
    
    xhr.send(data);
}

/**
 * Helper function to get cookie value
 */
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

/**
 * Called when user accepts cookies
 */
function optInAll() {
    setIBKRCookieAjax();
}

/**
 * Check on page load if user has already accepted cookies
 */
(function() {
    const gdprCookie = getCookie('IBKRcampus_gdpr_optIn');
    if (gdprCookie === 'true') {
        console.log('User has accepted cookies, setting IBKR cookie on page load');
        setIBKRCookieAjax();
    }
})();


/**
 * Helper function to get cookie value
 */
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

/**
 * Check on page load if user has already accepted cookies
 */
(function() {
    const gdprCookie = getCookie('IBKRcampus_gdpr_optIn');
    if (gdprCookie === 'true') {
        console.log('User has accepted cookies, setting IBKR cookie on page load');
        setIBKRCookieAjax();
    }
})();

// Functional Cookies
function functionalOptIn() {
  // if we’d previously opted out, remove the opt-out flag
  if (/(^|;)\s*IBKRcampus_functional_optOut/.test(document.cookie)) {
    deleteCookie('IBKRcampus_functional_optOut');
  }
  // set the opt-in cookie for 10 years
  gdprSet('IBKRcampus_functional_optIn', 'true', 3650);
}

function functionalOptOut() {
  // if we’d previously opted in, remove that
  if (/(^|;)\s*IBKRcampus_functional_optIn/.test(document.cookie)) {
    deleteCookie('IBKRcampus_functional_optIn');
  }
  // set a short-lived opt-out flag (2 days to mirror gdprOptOut)
  gdprSet('IBKRcampus_functional_optOut', 'true', 2);
}

// Cookie Functions
function optInAll() { 
	if (/(^|;)\s*IBKRcampus_gdpr_optOut/.test(document.cookie)) {
	deleteCookie('IBKRcampus_gdpr_optOut');
	}
	gdprSet('IBKRcampus_gdpr_optIn', 'true', 3650);	
	gdprSet('IBKRcampus_mktng_optIn', 'true', 3650);
	functionalOptIn();
	
	populateYTVideoCookiePlaceholder();
	
	writeGoogleTags();
	
	setIBKRCookieAjax();
}

function populateYTVideoCookiePlaceholder() {
	if (jQuery('.yt-video-blocked').length) {
	  jQuery('.yt-video-blocked').each(function() {
		var $block   = jQuery(this);
		var videoId  = $block.data('youtube-id');
		  if (jQuery(this).hasClass('yt-ta-embed')) {
			var embedHtml =
			  '<div class="youtube-course-popout">' +
				'<div id="youtube-course-popout-close">' +
				  '<svg xmlns="http://www.w3.org/2000/svg" width="118" height="118" viewBox="0 0 118 118" fill="none" aria-labelledby="closeMobileMenuSVG">' +
					'<title id="closeMobileMenuSVG">Close Navigation</title>' +
					'<path d="M110.831 0.722228L0.522461 111.031L7.16927 117.678L117.478 7.36903L110.831 0.722228Z" fill="black"/>' +
					'<path d="M117.478 111.031L7.16943 0.722229L0.522629 7.36903L110.831 117.678L117.478 111.031Z" fill="black"/>' +
				  '</svg>' +
				'</div>' +
				'<iframe ' +
				  'src="https://www.youtube.com/embed/' + videoId + '?rel=0" ' +
				  'frameborder="0" ' +
				  'allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" ' +
				  'allowfullscreen>' +
				'</iframe>' +
			  '</div>';
		  } else {
			var embedHtml =
			  '<div class="videoWrapper mb-3">' +
				'<iframe ' +
				  'src="https://www.youtube.com/embed/' + videoId + '?rel=0" ' +
				  'frameborder="0" ' +
				  'allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" ' +
				  'allowfullscreen>' +
				'</iframe>' +
			  '</div>';
		  }

		$block.replaceWith(embedHtml);
	  });
	}
}

function optOutAll() { 
	if (/(^|;)\s*IBKRcampus_gdpr_optIn/.test(document.cookie)) {
		deleteCookie('IBKRcampus_gdpr_optIn');
	}
	gdprSet('IBKRcampus_gdpr_optOut', 'true', 2);
	
	if (/(^|;)\s*IBKRcampus_options_optIn/.test(document.cookie)) {
		deleteCookie('IBKRcampus_options_optIn');
	}
	
	if (/(^|;)\s*IBKRcampus_mktng_optIn/.test(document.cookie)) {
		deleteCookie('IBKRcampus_mktng_optIn');
	}
	
	// Turn all radio buttons on the  manage cookies modal to No
	jQuery('input[name="performance"]').prop('checked', false);
	jQuery('input[name="performance"][value="no"]').prop('checked', true);
	jQuery('input[name="functional"]').prop('checked', false);
	jQuery('input[name="functional"][value="no"]').prop('checked', true);
	jQuery('input[name="marketing"]').prop('checked', false);
	jQuery('input[name="marketing"][value="no"]').prop('checked', true);
	
	functionalOptOut();
}

jQuery('input[name="functional"]').click(function() {
	if (jQuery(this).val() == 'yes') {
		deleteCookie('IBKRcampus_functional_optOut');
		gdprSet('IBKRcampus_functional_optIn', 'true', 3650);
	} else {
		deleteCookie('IBKRcampus_functional_optIn');
		gdprSet('IBKRcampus_functional_optOut', 'true', 3650);
	}
});

jQuery('input[name="marketing"]').click(function() {
	if (jQuery(this).val() == 'yes') {
		deleteCookie('IBKRcampus_mkting_optOut');
		gdprSet('IBKRcampus_mkting_optIn', 'true', 3650);
	} else {
		deleteCookie('IBKRcampus_mkting_optIn');
		gdprSet('IBKRcampus_mkting_optOut', 'true', 3650);
	}
});

function gdprOptIn() { 
	if (/(^|;)\s*IBKRcampus_gdpr_optOut/.test(document.cookie)) {
	deleteCookie('IBKRcampus_gdpr_optOut');
	}
	gdprSet('IBKRcampus_gdpr_optIn', 'true', 3650);
	
	writeGoogleTags();
	
	setIBKRCookieAjax();
}

function gdprOptOut() { 
	if (/(^|;)\s*IBKRcampus_gdpr_optIn/.test(document.cookie)) {
	deleteCookie('IBKRcampus_gdpr_optIn');
	}
	gdprSet('IBKRcampus_gdpr_optOut', 'true', 3650);
}

function optionsOptIn() { 
	optionsSet('IBKRcampus_options_optIn', 'true', 1);
}

function optionsOptOut() { 
	deleteCookie('IBKRcampus_options_optIn');
}

function mktngOptIn() { 
	gdprSet('IBKRcampus_mktng_optIn', 'true', 3650);
}

function mktngOptOut() { 
	deleteCookie('IBKRcampus_mktng_optIn');
	var d = new Date();
	d.setTime(d.getTime() - (1000*60*60*24));
	var expires = "expires=" + d.toGMTString();
	window.document.cookie = 'web'+"="+"; "+expires + ";path=/; SameSite=None; Secure";
}

function gdprSet(cname, cvalue, exdays) {    
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toUTCString();
    
    // Set the cookie for the origin domain
    var cookieString = cname + "=" + cvalue + "; " + expires + ";path=/; SameSite=None; Secure";
    
    document.cookie = cookieString;
    
	if (document.getElementById("privacy-bar")) {
		document.getElementById("privacy-bar").classList.add('bar-off');
		document.getElementById("privacy-bar").classList.remove('bar-on');
	}
}

function optionsSet(cname, cvalue, exdays) {
	var d = new Date();
	d.setTime(d.getTime() + (exdays*24*60*60*1000));
	var expires = "expires="+d.toUTCString();
	document.cookie = cname + "=" + cvalue + "; " + expires + ";path=/; SameSite=None; Secure";
}

function deleteCookie(cname) {
	var d = new Date();
	d.setTime(d.getTime() - (1000*60*60*24));
	var expires = "expires=" + d.toGMTString();
	window.document.cookie = cname+"="+"; "+expires + ";path=/; SameSite=None; Secure";
	//location.reload();
}

function getCookie(name) {
	var re = new RegExp(name + "=([^;]+)"); 
	var value = re.exec(document.cookie); 
	return (value != null) ? unescape(value[1]) : null; 
}

