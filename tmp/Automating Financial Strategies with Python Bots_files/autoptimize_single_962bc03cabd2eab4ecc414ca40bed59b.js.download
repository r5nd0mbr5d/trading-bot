(function($){'use strict';function collectAnswers($form){const answers=[];$form.find('.taqm-q').each(function(i){const val=$(`input[name="q${i}"]:checked`,this).val();answers.push(typeof val==='undefined'?-1:parseInt(val,10));});return answers;}
$(function(){$(document).on('submit','.taqm-quiz-form',async function(e){e.preventDefault();const $form=$(this);const postId=parseInt($form.attr('data-post')||'0',10)||0;const answers=collectAnswers($form);const loadingId=`quiz-results-loading-${postId}`;$form.replaceWith(`<div id="${loadingId}" class="taqm-quiz-results">Grading...</div>`);const $target=$(`#${loadingId}`);const url='https://www.interactivebrokers.com/campus/wp-admin/admin-ajax.php?action=taqm_grade_quiz';const params=new URLSearchParams();params.append('nonce',TAQM_FRONT.nonce);params.append('post_id',String(postId));answers.forEach(a=>params.append('answers[]',String(a)));try{const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:params.toString(),credentials:'same-origin'});if(!res.ok){const text=await res.text();console.error('HTTP error grading quiz',res.status,text);$target.replaceWith('<div class="taqm-result">Error grading quiz</div>');return;}
const resp=await res.json();if(resp&&resp.success){const r=resp.data||{};const gradedPostId=Number(r.post_id??postId);const html=`<div id="quiz-results-${gradedPostId}" class="taqm-quiz-results">
               <h3>Score</h3>
				<div class="score-badge ${
				r.percent === 100 ? 'badge-green' : (r.percent > 0 ? 'badge-yellow' : '')
				}">${r.percent}%</div>
               <p class="mt-3"><strong>You got ${r.score}/${r.total} answers correct.</strong></p>
             </div>`;$target.replaceWith(html);$(()=>{const $badge=$(`#badge-${gradedPostId}`);if(!$badge.length)return;const newPct=Number(r.percent);const m=String($badge.text()).match(/(\d{1,3})\s*%/);const oldPct=m?Math.min(100,Math.max(0,parseInt(m[1],10))):-1;if(oldPct<newPct||oldPct===-1){$badge.removeClass('off incomplete complete');$badge.addClass(newPct===0?'off':(newPct===100?'complete':'incomplete'));const $span=$badge.find('> div > span');if($span.length){$span.text(`${newPct}%`);}else{$badge.html(`<div><span>${newPct}%</span></div>`);}}});const ctaSel='#quiz-results-cta-buttons-'+gradedPostId;if($(ctaSel).length){$(ctaSel).show();}else{$('#quiz-results-cta-buttons').show();}}else{console.error('Grade error payload:',resp);$target.replaceWith('<div class="taqm-result">Error grading quiz</div>');}}catch(err){console.error('Fetch failed:',err);$target.replaceWith('<div class="taqm-result">Network error</div>');}});});})(jQuery);